<!-- https://drtau01.github.io/BDfGsKqS5h3Wf9f/whystkmoving.htm -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Why Stock Moving</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 30px; background-color: #f4f7f6; }
        #output { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .ticker-row { display: flex; align-items: flex-start; justify-content: space-between; padding: 12px; border-bottom: 1px solid #eee; }
        .ticker-row:last-child { border-bottom: none; }
        .ticker-name { font-weight: bold; color: #333; font-size: 1.1em; padding: 10px; }
        .ticker-data { color: #307dcc; font-family: monospace; font-weight: bold; }
        .error { color: #e74c3c; }
    </style>
</head>
<body>
    <h1>Why Stock Moving</h1>
    <div id="output">Fetching data...</div>

    <script>
        const proxy = "https://api.allorigins.win/get?url=";
        const baseUrl = "https://finviz.com/quote.ashx?t=";

		// Get tickers from URL parameters (?tickers=AAPL,TSLA)
        const urlParams = new URLSearchParams(window.location.search);
        const tickerParam = urlParams.get('tickers');

		// Default list if no argument is provided
        const tickers = tickerParam ? tickerParam.split(',') : [];

        async function scrapeTickers() {
            const outputDiv = document.getElementById('output');

			if (tickers.length === 0) {
                outputDiv.innerHTML = "Missing tickers in URL (e.g. ?tickers=AAPL,TSLA).";
                return;
            }
            
            try {
                const promises = tickers.map(ticker => 
                    fetch(`${proxy}${encodeURIComponent(baseUrl + ticker + "&p=d")}`)
                        .then(res => res.json())
                        .then(data => ({ ticker, html: data.contents }))
                        .catch(err => ({ ticker, error: err }))
                );

                const results = await Promise.all(promises);
                outputDiv.innerHTML = ""; 

                results.forEach(result => {
                    const row = document.createElement('div');
                    row.className = 'ticker-row';

                    if (result.error) {
                        row.innerHTML = `<span class="ticker-name">${result.ticker}</span> <span class="error">  </span>`;
                    } else {
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(result.html, "text/html");
						
						// const scrapedData = doc.querySelector('h1').innerText;   // Example: Grabbing the first <h1> found on the page
						let scrapedData = doc.querySelector('.js-why-stock-moving-static').innerText;
						const processedData = scrapedData.replace("/.+:\d\d (AM|PM)/g", "$&&nbsp;&nbsp;");
                        
                        row.innerHTML = `
                            <span class="ticker-name">${result.ticker}</span>
                            <span class="ticker-data">${processedData}</span>
                        `;
                    }
                    outputDiv.appendChild(row);
                });

            } catch (err) {
                outputDiv.innerHTML = "Critical system error: " + err;
            }
        }

        scrapeTickers();
    </script>
</body>
</html>
